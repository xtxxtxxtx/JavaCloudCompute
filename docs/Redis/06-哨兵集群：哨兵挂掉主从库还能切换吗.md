哨兵机制可以实现主从库的自动切换，通过部署多个实例就形成一个哨兵集群。哨兵集群中的多个实例共同判断，可以降低对主库下线的误判率。但是如果有哨兵实例在运行时发生故障，主从库是否还能正常切换。

实际上一旦多个实例组成了哨兵集群，即使有哨兵实例出现故障挂掉，其他哨兵还能继续协作完成主从库切换的工作，包括判定主库是不是处于下线状态选择新主库，以及通知从库和客户端。如果部署过哨兵集群的话就会知道，在配置哨兵的信息时候只需要用到下面的这个配置项，设置主库的 IP 和端口，并没有配置其他哨兵的连接信息。
```java
sentinel monitor <master-name> <ip> <redis-port> <quorum> 
```
# 基于pub/sub机制的哨兵集群组成
哨兵实例之间可以相互发现要说到Redis提供的pub/sub机制，也就是发布/订阅机制。

哨兵只要和主库建立起连接，就可以在主库上发布消息，比如说发布它自己的连接信息（IP 和端口）。同时也可以从主库上订阅消息，获得其他哨兵发布的连接信息。当多个哨兵实例都在主库上做了发布和订阅操作后，它们之间就能知道彼此的 IP 地址和端口。

除了哨兵实例，自己编写的应用程序也可以通过 Redis 进行消息的发布和订阅。因此为了区分不同应用的消息，Redis 会以频道的形式，对这些消息进行分门别类的管理。所谓的频道实际上就是消息的类别。当消息类别相同时，它们就属于同一个频道。反之就属于不同的频道。只有订阅了同一个频道的应用，才能通过发布的消息进行信息交换。在主从集群中主库上有一个名为“__sentinel__:hello”的频道，不同哨兵就是通过它来相互发现来实现互相通信的。

举例具体说明一下。在下图中哨兵 1 把自己的 IP（172.16.19.3）和端口（26579）发布到“__sentinel__:hello”频道上，哨兵 2 和 3 订阅了该频道。那么此时哨兵 2 和 3 就可以从这个频道直接获取哨兵 1 的 IP 地址和端口号。然后哨兵 2、3 可以和哨兵 1 建立网络连接。通过这个方式哨兵 2 和 3 也可以建立网络连接，这样一来哨兵集群就形成。它们相互间可以通过网络连接进行通信，比如说对主库有没有下线这件事儿进行判断和协商。
![在这里插入图片描述](https://img-blog.csdnimg.cn/d1a5e9c19cc44028b77eeafe08d1b1c7.png)
哨兵除了彼此之间建立起连接形成集群外，还需要和从库建立连接。这是因为在哨兵的监控任务中，它需要对主从库都进行心跳判断，而且在主从库切换完成后它还需要通知从库，让它们和新主库进行同步。那么哨兵是如何知道从库的 IP 地址和端口的呢？这是由哨兵向主库发送 INFO 命令来完成的。就像下图所示哨兵 2 给主库发送 INFO 命令，主库接受到这个命令后，就会把从库列表返回给哨兵。接着哨兵就可以根据从库列表中的连接信息，和每个从库建立连接，并在这个连接上持续地对从库进行监控。哨兵 1 和 3 可以通过相同的方法和从库建立连接。
![在这里插入图片描述](https://img-blog.csdnimg.cn/dc84d90ff76e4b9cb43eec157e42ee51.png)
通过 pub/sub 机制哨兵之间可以组成集群，同时哨兵又通过 INFO 命令获得从库连接信息也能和从库建立连接，并进行监控。但是哨兵不能只和主、从库连接。因为主从库切换后客户端也需要知道新主库的连接信息，才能向新主库发送请求操作。所以哨兵还需要完成把新主库的信息告诉客户端这个任务。而且在实际使用哨兵时，有时会遇到这样的问题：如何在客户端通过监控了解哨兵进行主从切换的过程呢？比如说主从切换进行到哪一步了？这其实就是要求，客户端能够获取到哨兵集群在监控、选主、切换这个过程中发生的各种事件。此时仍然可以依赖 pub/sub 机制来完成哨兵和客户端间的信息同步。

# 基于pub/sub机制的客户端事件通知
哨兵其实就是一个运行在特定模式下的Redis实例，只不过它并不服务请求操作，只是完成监控、选主和通知的任务。所以每个哨兵实例也提供pub/sub机制，客户端可以从哨兵订阅消息。哨兵提供的消息订阅频道很多，不同拼单包含主从库切换过程中的不同关键事件。
![在这里插入图片描述](https://img-blog.csdnimg.cn/394dac4c26e141cba9acb5d3fa26d4b1.png)
知道这些频道后可让客户端从哨兵订阅消息。具体操作步骤是：客户端读取哨兵的配置文件之后可以获得哨兵的地址和端口，与哨兵建立网络连接。然后在客户端执行订阅命令来获取不同的事件消息。

执行下面的命令去订阅所有实例进入客观下线状态的事件：
```java
SUBSCRIBE +odown
```
订阅所有文件命令：
```java
PSUBSCRIBE  *
```
哨兵将新主库选取出来后客户端会看到下面的switch-master事件。该事件表示主库已经切换，新主库的ip地址和端口信息已经存在，此时客户端可用新主库地址和端口进行通信。
```java
switch-master <master name> <oldip> <oldport> <newip> <newport>
```
有了这些事件通知客户端不仅可以在主从切换后得到新主库的连接信息，还可以监控到主从库切换过程中发生的各个重要事件。这样客户端就可知道主从切换进行到哪一步，有助于了解切换速度。

pub/sub机制，哨兵和哨兵之间、哨兵和从库之间、哨兵和客户端之间就都能建立起连接，再加上主库下线判断和选主依据、哨兵集群的监控、选主和通知三个任务基本可以正常工作。但是需要思考一个问题主库故障之后哨兵集群有多个实例，该如何确定哪个哨兵进行实际主从切换。
# 哪个哨兵执行主从切换
确定哪个哨兵执行主从切换过程和主库客观下线判断过程类似，也是一个投票仲裁的过程。哨兵集群要判定主库客观下线，需要有一定数量的实例都认为该主库已经主观下线。

任何一个实例只要自身判断主库主观下线后，就给其他实例发送is-master-down-by-addr命令。接着其他实例会根据和主库连接情况，做出Y or N的响应，Y相当于赞成，N相当于反对。
![在这里插入图片描述](https://img-blog.csdnimg.cn/fbb1b69b12a54565820b9b5766466362.png)
一个哨兵获取仲裁所需赞成票数后，就可以标记主库为“客观下线”。这个所需的赞成票数是通过哨兵配置文件中的 quorum 配置项设定的。例如现在有 5 个哨兵，quorum 配置的是 3，那么一个哨兵需要 3 张赞成票，就可以标记主库为“客观下线”。这 3 张赞成票包括哨兵自己的一张赞成票和另外两个哨兵的赞成票。此时这个哨兵就可以再给其他哨兵发送命令，表明希望由自己来执行主从切换，并让所有其他哨兵进行投票。这个投票过程称为“Leader 选举”。因为最终执行主从切换的哨兵称为 Leader，投票过程就是确定 Leader。

在投票过程中任何一个想成为 Leader 的哨兵，要满足两个条件：第一，拿到半数以上的赞成票；第二，拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值。以 3 个哨兵为例，假设此时的 quorum 设置为 2，那么任何一个想成为 Leader 的哨兵只要拿到 2 张赞成票即可。如下图所示是展示一下 3 个哨兵、quorum 为 2 的选举过程。
![在这里插入图片描述](https://img-blog.csdnimg.cn/97c1065733ed402ba1d8828aa9810eac.png)
在 T1 时刻，S1 判断主库为“客观下线”想成为 Leader，就先给自己投一张赞成票，然后分别向 S2 和 S3 发送命令，表示要成为 Leader。

在 T2 时刻，S3 判断主库为“客观下线”也想成为 Leader，所以也先给自己投一张赞成票，再分别向 S1 和 S2 发送命令，表示要成为 Leader。

在 T3 时刻，S1 收到 S3 的 Leader 投票请求。因为 S1 已经给自己投了一票 Y，所以它不能再给其他哨兵投赞成票，所以 S1 回复 N 表示不同意。同时S2 收到T2 时 S3 发送的 Leader 投票请求，因为 S2 之前没有投过票，它会给第一个向它发送投票请求的哨兵回复 Y，给后续再发送投票请求的哨兵回复 N，所以在 T3 时S2 回复 S3，同意 S3 成为 Leader。

在 T4 时刻，S2 才收到 T1 时 S1 发送的投票命令。因为 S2 已经在 T3 时同意 S3 的投票请求，此时S2 给 S1 回复 N，表示不同意 S1 成为 Leader。发生这种情况是因为 S3 和 S2 之间的网络传输正常，而 S1 和 S2 之间的网络传输可能正好拥塞导致投票请求传输出现延迟。

最后在 T5 时刻，S1 得到的票数是来自它自己的一票 Y 和来自 S2 的一票 N。而 S3 除了自己的赞成票 Y 以外，还收到来自 S2 的一票 Y。此时S3 不仅获得半数以上的 Leader 赞成票，也达到预设的 quorum 值（quorum 为 2），所以它最终成为Leader。接着S3 会开始执行选主操作，而且在选定新主库后会给其他从库和客户端通知新主库的信息。

如果 S3 没有拿到 2 票 Y，那么这轮投票就不会产生 Leader。哨兵集群会等待一段时间（也就是哨兵故障转移超时时间的 2 倍），再重新选举。这是因为哨兵集群能够进行成功投票，很大程度上依赖于选举命令的正常网络传播。如果网络压力较大或有短时堵塞，就可能导致没有一个哨兵能拿到半数以上的赞成票。所以等到网络拥塞好转之后，再进行投票选举，成功的概率就会增加。

需要注意的是，如果哨兵集群只有 2 个实例，此时一个哨兵要想成为 Leader，必须获得 2 票，而不是 1 票。所以如果有个哨兵挂掉，那么此时的集群是无法进行主从库切换的。因此通常需要至少配置3个哨兵实例。
